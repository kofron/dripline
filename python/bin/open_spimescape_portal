#!/usr/bin/python
'''
Script to replace start_node using the spimescape abstraction upgrades
'''

from __future__ import print_function

import yaml

import dripline

import logging
logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)


def open_spimescape_portal(nodename, broker, **kwargs):
    '''
    '''
    # create the portal:
    portal = dripline.core.Portal(nodename, broker)
    logger.info('starting {}'.format(nodename))
    ##### need to fix the node class here...
    for provider in kwargs['providers']:
        portal.add_endpoint(create_child(portal, provider))
    logger.info('spimescapes created and populated')
    #logger.info('creating bindings')
    #portal.create_bindings()
    logger.info('starting consumption')
    portal.start_event_loop()

def create_child(portal, conf_dict):
    module = conf_dict.pop('module')
    child_confs = conf_dict.pop('endpoints', [])
    logger.info('creating a <{}> with args:\n{}'.format(module, conf_dict))
    if hasattr(dripline.instruments, module):
        this_child = getattr(dripline.instruments, module)(**conf_dict)
    elif hasattr(dripline.core, module):
        this_child = getattr(dripline.core, module)(**conf_dict)
    else:
        raise NameError('no module "{}" in dripline.core or dripline.instruments'.format(module))

    for child_dict in child_confs:
        this_child.add_endpoint(create_child(portal, child_dict))
    if isinstance(this_child, dripline.core.Provider):
        for grandchild in this_child.endpoints:
            portal.add_endpoint(this_child.endpoints[grandchild])
    return this_child

if __name__ == '__main__':
    parser = dripline.core.DriplineParser(extra_logger=logger, 
                                          amqp_broker=True,
                                          config_file=True,
                                          tmux_support=True,
                                          twitter_support=True,
                                          user_pass_support=True,
                                         )
    
    args = parser.parse_args()
    logger.info('args parsed, reading config')
    conf_dict = args.config
    logger.info('config parsed')
    if args.broker:
        conf_dict.update({'broker':args.broker})
    try:
        open_spimescape_portal(**conf_dict)
    except KeyboardInterrupt:
        import threading
        logger.info('there are {} total threads'.format(threading.active_count()))
        for thread in threading.enumerate():
            if thread.name.startswith('logger_'):
                logger.info('canceling a thread named: {}'.format(thread.name))
                thread.cancel()
